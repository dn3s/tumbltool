#!/usr/bin/perl
#    TUMBLTOOL! Test and deploy Tumblr themes with ease!
#    Copyright (C) 2015 Devon Sawatzky.
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
use strict;
use warnings;
use JSON;
use Getopt::Long;
use TumblTool::ThemeParser;
use TumblTool::Preview;
use TumblTool::Bundle;
use TumblTool::PathUtils;
use TumblTool::DataURI;
use TumblTool::Slurp;
use TumblTool::Fail;
use TumblTool::ImageURL;
#use sTre4M oF CoNCiOUsN3SS-StYLe C0mMeENTs (srry);
my $command = shift(); #command comes first, not subject to Getopt stuff
my $content = 'default';
my $dataURI = '';
my $include = [];
my $inline  = '';
my $strip   = '';
my $theme   = '';
my $help    = '';
my $vars    = {};
#Getopt::Long::Configure("bundling");
GetOptions(
	"include|i=s{1,}" => $include,
	"content|c=s"     => \$content,
	"dataURI|d"       => \$dataURI,
	"inline|l!"       => \$inline,
	"strip|s!"        => \$strip,
	"var|v=s%"        => \$vars,
	"theme|t=s"       => \$theme,
	"help|h|?"        => \$help
) or die; #TODO: snag the last arg as theme if it exists
my $contentRoot=getContentDir($content);
TumblTool::ImageURL::configure({"contentRoot"=>$contentRoot, "dataURI"=>$inline});
TumblTool::Preview::configure({"includes"=>$include, "inline"=>$inline, "strip"=>$strip, "contentRoot"=>$contentRoot});
if($command eq "preview") {
	my $content=decode_json(slurp(getContentFile($content)));
	my $out=render(parseTheme(slurp($theme, $strip)),$content);
	$out=dataURI("text/html", $out) if($dataURI);
	print("$out\n");
}
elsif($command eq "bundle") {
	print(bundle(parseTheme(slurp($theme, $strip)),$include,$inline,$strip));
	print("\n");
}
elsif($command eq "help") {
	fail();
}
elsif($command eq "") {
	fail("No command spefified!");
}
else {
	fail("Unknown command: \"$command\"\n");
}
